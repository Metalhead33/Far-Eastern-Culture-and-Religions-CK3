namespace = jewish_courtier

scripted_trigger jewish_courtier_basic_requirements_trigger = {
	is_adult = yes
	is_imprisoned = no
	is_alive = yes # Because apparently there can be dead characters in the pool (remove when fixed)
	OR = {
	has_religion = religion:judaism_religion
	has_culture_group = culture_group:israelite_group
	}
}

scripted_trigger jewish_courtier_excellent_skill_intrigue_trigger = {
	jewish_courtier_basic_requirements_trigger = yes
	intrigue >= high_skill_rating
}

scripted_trigger jewish_courtier_high_skill_intrigue_trigger = {
	jewish_courtier_basic_requirements_trigger = yes	
	OR = {
		#Empire/kingdom
		AND = {
			root = { highest_held_title_tier >= tier_kingdom }
			intrigue >= decent_skill_rating #Will be pushed up to high by adding schemer/reveler traits
			NAND = {
				has_trait = schemer
				NOT = { has_trait = lifestyle_reveler }
			}
		}
		#Duchy/county
		AND = {
			root = { highest_held_title_tier <= tier_duchy }
			NOR = {
				intrigue > high_skill_rating
				has_trait = reveler_3
				has_trait = schemer
			}
			intrigue >= mediocre_skill_rating #Will be pushed up to medium by adding schemer/reveler traits
		}
	}
}

scripted_trigger jewish_courtier_excellent_skill_diplomacy_trigger = {
	jewish_courtier_basic_requirements_trigger = yes
	diploamcy >= high_skill_rating
}

scripted_trigger jewish_courtier_high_skill_diplomacy_trigger = {
	jewish_courtier_basic_requirements_trigger = yes	
	OR = {
		#Empire/kingdom
		AND = {
			root = { highest_held_title_tier >= tier_kingdom }
			diplomacy >= decent_skill_rating #Will be pushed up to high by adding diplomat/reveler traits
			NAND = {
				has_trait = diplomat
				NOT = { has_trait = lifestyle_reveler }
			}
		}
		#Duchy/county
		AND = {
			root = { highest_held_title_tier <= tier_duchy }
			NOR = {
				diplomacy > high_skill_rating
				has_trait = reveler_3
				has_trait = diplomat
			}
			diplomacy >= mediocre_skill_rating #Will be pushed up to medium by adding diplomat/reveler traits
		}
	}
}

scripted_trigger jewish_courtier_excellent_skill_stewardship_trigger = {
	jewish_courtier_basic_requirements_trigger = yes
	stewardship >= high_skill_rating
}

scripted_trigger jewish_courtier_high_skill_stewardship_trigger = {
	jewish_courtier_basic_requirements_trigger = yes	
	OR = {
		#Empire/kingdom
		AND = {
			root = { highest_held_title_tier >= tier_kingdom }
			stewardship >= decent_skill_rating #Will be pushed up to high by adding administrator/avaricious/architect traits
			NAND = {
				has_trait = administrator
				has_trait = avaricious
				has_trait = architect
			}
		}
		#Duchy/county
		AND = {
			root = { highest_held_title_tier <= tier_duchy }
			NOR = {
				stewardship > high_skill_rating
				has_trait = avaricious
				has_trait = administrator
				has_trait = architect
			}
			stewardship >= mediocre_skill_rating #Will be pushed up to medium by adding administrator/avaricious/architect  traits
		}
	}
}

# Jewish courtier - Ashkenazi Intrigue
jewish_courtier.0001 = {
	type = character_event
	title = jewish_courtier.intrigue.t
	desc = jewish_courtier.intrigue.desc
	theme = learning
	left_portrait = {
		character = scope:new_courtier
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }
	trigger = { exists = capital_province } #If I lost it before I got this event, I shouldn't get a Court Jew

	immediate = {
		hidden_effect = {
		random_pool_character = {
			province = root.capital_province
			limit = { jewish_courtier_excellent_skill_intrigue_trigger = yes }
			save_scope_as = new_courtier
		}
		if = {
			limit = { NOT = { exists = scope:new_courtier } }
			if = {
				limit = { 
					root = {
						capital_province = {
							OR = {
								AND = {	geographical_region = world_europe_west
										NOT = { geographical_region = world_europe_west_iberia } }
								geographical_region = world_europe_north
								geographical_region = world_europe_east
							}
						}
					}
				}
				create_character = {
					employer = root
					template = ashkenazi_intrigue_character
					save_scope_as = new_courtier
				}
			}
			if = {
				limit = { 
					root = {
						capital_province = {
							OR = {
							geographical_region = world_europe_west_iberia
							geographical_region = world_europe_south
							geographical_region = world_asia_minor
							geographical_region = world_middle_east_persia
							geographical_region = world_middle_east
							geographical_region = world_africa_north
							}
						}
					}
				}
				create_character = {
					employer = root
					template = sephardi_intrigue_character
					save_scope_as = new_courtier
				}
			}
			if = {
				limit = { 
					root = {
						capital_province = {
							geographical_region = ghw_region_khotan
						}
					}
				}
				create_character = {
					employer = root
					template = kaifeng_intrigue_character
					save_scope_as = new_courtier
				}
			}
			# Ultimate fallback
			if = {
			limit = { NOT = { exists = scope:new_courtier } }
			create_character = {
				employer = root
				template = sephardi_intrigue_character
				save_scope_as = new_courtier
			}
			}
			scope:new_courtier = {
				set_to_lowborn = yes
			}
		}
		}
	}

	option = { #Welcome!
		name = jewish_courtier.accept
		pay_short_term_gold = {
			target = scope:new_courtier
			gold = high_skill_court_physician_cost
		}
		add_courtier = scope:new_courtier
		set_spymaster_effect = {
			EMPLOYER = root
			EMPLOYEE = scope:new_courtier
		}
		reverse_add_opinion = {
			target = scope:new_courtier
			modifier = hired_me_opinion
		}
		stress_impact = {
			zealous = minor_stress_impact_gain
		}
	}

	option = { #Send away
		name = jewish_courtier.banish
		scope:new_courtier = {
			banish = yes
			add_opinion = {
				modifier = banished_me
				target = root
			}
		}
	}
}

# Jewish courtier - Ashkenazi Stewardship
jewish_courtier.0002 = {
	type = character_event
	title = jewish_courtier.steward.t
	desc = jewish_courtier.steward.desc
	theme = learning
	left_portrait = {
		character = scope:new_courtier
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }
	trigger = { exists = capital_province } #If I lost it before I got this event, I shouldn't get a Court Jew

	immediate = {
		hidden_effect = {
		random_pool_character = {
			province = root.capital_province
			limit = { jewish_courtier_excellent_skill_stewardship_trigger = yes }
			save_scope_as = new_courtier
		}
		if = {
			limit = { NOT = { exists = scope:new_courtier } }
			if = {
				limit = { 
					root = {
						capital_province = {
							OR = {
								AND = {	geographical_region = world_europe_west
										NOT = { geographical_region = world_europe_west_iberia } }
								geographical_region = world_europe_north
								geographical_region = world_europe_east
							}
						}
					}
				}
				create_character = {
					employer = root
					template = ashkenazi_steward_character
					save_scope_as = new_courtier
				}
			}
			if = {
				limit = { 
					root = {
						capital_province = {
							OR = {
							geographical_region = world_europe_west_iberia
							geographical_region = world_europe_south
							geographical_region = world_asia_minor
							geographical_region = world_middle_east_persia
							geographical_region = world_middle_east
							geographical_region = world_africa_north
							}
						}
					}
				}
				create_character = {
					employer = root
					template = sephardi_steward_character
					save_scope_as = new_courtier
				}
			}
			if = {
				limit = { 
					root = {
						capital_province = {
							geographical_region = ghw_region_khotan
						}
					}
				}
				create_character = {
					employer = root
					template = kaifeng_steward_character
					save_scope_as = new_courtier
				}
			}
			# Ultimate fallback
			if = {
			limit = { NOT = { exists = scope:new_courtier } }
			create_character = {
				employer = root
				template = sephardi_steward_character
				save_scope_as = new_courtier
			}
			}
			scope:new_courtier = {
				set_to_lowborn = yes
			}
		}
		}
	}

	option = { #Welcome!
		name = jewish_courtier.accept
		pay_short_term_gold = {
			target = scope:new_courtier
			gold = high_skill_court_physician_cost
		}
		add_courtier = scope:new_courtier
		set_steward_effect = {
			EMPLOYER = root
			EMPLOYEE = scope:new_courtier
		}
		reverse_add_opinion = {
			target = scope:new_courtier
			modifier = hired_me_opinion
		}
		stress_impact = {
			zealous = minor_stress_impact_gain
		}
	}

	option = { #Send away
		name = jewish_courtier.banish
		scope:new_courtier = {
			banish = yes
			add_opinion = {
				modifier = banished_me
				target = root
			}
		}
	}
}

# Jewish courtier - Ashkenazi Diploamcy
jewish_courtier.0003 = {
	type = character_event
	title = jewish_courtier.diplomat.t
	desc = jewish_courtier.diplomat.desc
	theme = learning
	left_portrait = {
		character = scope:new_courtier
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }
	trigger = { exists = capital_province } #If I lost it before I got this event, I shouldn't get a Court Jew

	immediate = {
		hidden_effect = {
		random_pool_character = {
			province = root.capital_province
			limit = { jewish_courtier_excellent_skill_diplomacy_trigger = yes }
			save_scope_as = new_courtier
		}
		if = {
			limit = { NOT = { exists = scope:new_courtier } }
			if = {
				limit = { 
					root = {
						capital_province = {
							OR = {
								AND = {	geographical_region = world_europe_west
										NOT = { geographical_region = world_europe_west_iberia } }
								geographical_region = world_europe_north
								geographical_region = world_europe_east
							}
						}
					}
				}
				create_character = {
					employer = root
					template = ashkenazi_diplomat_character
					save_scope_as = new_courtier
				}
			}
			if = {
				limit = { 
					root = {
						capital_province = {
							OR = {
							geographical_region = world_europe_west_iberia
							geographical_region = world_europe_south
							geographical_region = world_asia_minor
							geographical_region = world_middle_east_persia
							geographical_region = world_middle_east
							geographical_region = world_africa_north
							}
						}
					}
				}
				create_character = {
					employer = root
					template = sephardi_diplomat_character
					save_scope_as = new_courtier
				}
			}
			if = {
				limit = { 
					root = {
						capital_province = {
							geographical_region = ghw_region_khotan
						}
					}
				}
				create_character = {
					employer = root
					template = kaifeng_diplomat_character
					save_scope_as = new_courtier
				}
			}
			# Ultimate fallback
			if = {
			limit = { NOT = { exists = scope:new_courtier } }
			create_character = {
				employer = root
				template = sephardi_diplomat_character
				save_scope_as = new_courtier
			}
			}
			scope:new_courtier = {
				set_to_lowborn = yes
			}
		}
		}
	}

	option = { #Welcome!
		name = jewish_courtier.accept
		pay_short_term_gold = {
			target = scope:new_courtier
			gold = high_skill_court_physician_cost
		}
		add_courtier = scope:new_courtier
		set_chancellor_effect = {
			EMPLOYER = root
			EMPLOYEE = scope:new_courtier
		}
		reverse_add_opinion = {
			target = scope:new_courtier
			modifier = hired_me_opinion
		}
		stress_impact = {
			zealous = minor_stress_impact_gain
		}
	}

	option = { #Send away
		name = jewish_courtier.banish
		scope:new_courtier = {
			banish = yes
			add_opinion = {
				modifier = banished_me
				target = root
			}
		}
	}
}

# on_new_holder: New ruler gets Expelled Jews modifier.
jewish_courtier.0004 = {
	type = character_event
	hidden = yes
	trigger = {
		is_ruler = yes
		is_independent_ruler = yes
		NOT = { has_character_modifier = expelled_the_jews }
	}

	immediate = {
		if = {
			limit = {
				scope:previous_holder = {
					has_character_modifier = expelled_the_jews
				}
			}
		add_character_modifier = expelled_the_jews
		}
	}
}

# Jews are expelled!
jewish_courtier.0005 = {
	type = character_event
	title = jewish_courtier.0005.t
	desc = jewish_courtier.0005.desc
	theme = learning
	left_portrait = {
		character = root
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }

	immediate = {
		play_music_cue = "mx_cue_stress"
	}
	option = { #Send them away
		name = jewish_courtier.0005.a
		if = {
			limit = {
				has_character_modifier = borrowed_from_jews
			}
		remove_character_modifier = borrowed_from_jews
		}
		add_gold = 2000
		add_character_modifier = expelled_the_jews
		add_character_flag = expelled_the_jews_timer
		
		hidden_effect = {
		every_courtier_or_guest  = {
		limit = { has_religion = religion:judaism_religion }
			banish = yes
			add_opinion = {
				modifier = banished_me
				target = root
			}
		}
		}
		custom_tooltip = jews_are_expelled
	}

}
# Jews are expelled - inform vassals
jewish_courtier.0006 = {
	type = character_event
	theme = learning
	left_portrait = {
		character = top_liege
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }

	immediate = {
		play_music_cue = "mx_cue_stress"
	}
	option = {
		name = jewish_courtier.0006.a
		if = {
			limit = {
				has_character_modifier = borrowed_from_jews
			}
		remove_character_modifier = borrowed_from_jews
		}
		add_gold = 100
		hidden_effect = {
		every_courtier_or_guest  = {
		limit = { has_religion = religion:judaism_religion }
			banish = yes
			add_opinion = {
				modifier = banished_me
				target = top_liege
			}
		}
		}
		custom_tooltip = jews_are_expelled
	}
}

# Jews are welcomed back
jewish_courtier.0007 = {
	type = character_event
	title = jewish_courtier.0007.t
	desc = jewish_courtier.0007.desc
	theme = learning
	left_portrait = {
		character = root
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }

	immediate = {
		play_music_cue = "mx_cue_peace_ensues"
		}
	option = { # Welcome them back
		name = jewish_courtier.0007.a
		if = {
			limit = {
				remove_character_modifier = expelled_the_jews
			}
		remove_character_modifier = expelled_the_jews
	}
	}

}

# Jews are welcomed back
jewish_courtier.0008 = {
	type = character_event
	title = jewish_courtier.0007.t
	desc = jewish_courtier.0007.desc
	theme = learning
	left_portrait = {
		character = top_liege
		animation = personality_greedy
	}
	override_background = { event_background = throne_room }

	immediate = {
		play_music_cue = "mx_cue_peace_ensues"
	}
	option = { # Welcome them back
		name = jewish_courtier.0008.a
	}
}

# on_new_holder: Jewish loans get inherited! Huzzah!
jewish_courtier.0009 = {
	type = character_event
	hidden = yes
	trigger = {
		is_ruler = yes
		is_independent_ruler = yes
		NOT = { has_character_modifier = borrowed_from_jews }
	}

	immediate = {
		if = {
			limit = {
				scope:previous_holder = {
					has_character_modifier = borrowed_from_jews
				}
			}
		add_character_modifier = borrowed_from_jews
		}
	}
}

# Jews get un-expelled when you are Jewish
jewish_courtier.0010 = {
	type = character_event
	hidden = yes
	trigger = {
		has_religion = religion:judaism_religion
		has_character_modifier = expelled_the_jews
	}

	immediate = {
		if = {
			limit = {
				remove_character_modifier = expelled_the_jews
			}
		remove_character_modifier = expelled_the_jews
		if = {
			limit = {
				remove_character_modifier = borrowed_from_jews
			}
		remove_character_modifier = borrowed_from_jews
	}
}
}
}
